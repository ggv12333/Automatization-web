name: CI Minimal

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Provide fake external tools for tests (vina/reduce/scrub)
        run: |
          mkdir -p ./tools/bin
          printf '#!/bin/sh\nif [ "$1" = "--version" ] || [ "$1" = "-v" ]; then\n  echo "AutoDock Vina 1.2.5"\n  exit 0\nfi\necho "Vina shim called: $@" >&2\nexit 0\n' > ./tools/bin/vina

          printf '#!/bin/sh\ncat "$1"\n' > ./tools/bin/reduce

          printf '#!/bin/sh\ncp "$1" "$2"\n' > ./tools/bin/scrub.py

          chmod +x ./tools/bin/*
          echo "PATH=$(pwd)/tools/bin:$PATH" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run backend tests
        working-directory: ./backend
        run: npm test -- --ci

      - name: Archive coverage (if present)
        run: |
          if [ -d backend/coverage ]; then
            tar -czf coverage.tar.gz -C backend coverage
          else
            mkdir -p .tmp_empty && tar -czf coverage.tar.gz -C .tmp_empty .
          fi

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: backend-coverage
          path: coverage.tar.gz
          retention-days: 5
